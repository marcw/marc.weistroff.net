<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: vcl | Another brain on earth]]></title>
  <link href="http://marc.weistroff.net/blog/categories/vcl/atom.xml" rel="self"/>
  <link href="http://marc.weistroff.net/"/>
  <updated>2015-01-07T17:19:24+01:00</updated>
  <id>http://marc.weistroff.net/</id>
  <author>
    <name><![CDATA[Marc Weistroff]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Serving a maintenance page with varnish]]></title>
    <link href="http://marc.weistroff.net/2012/01/19/a-maintenance-page-served-by-varnish/"/>
    <updated>2012-01-19T00:00:00+01:00</updated>
    <id>http://marc.weistroff.net/2012/01/19/a-maintenance-page-served-by-varnish</id>
    <content type="html"><![CDATA[<p>Yesterday during the SOPA Blackout, this website was on strike. The
billions of readers of this blog had a static page explaining why this
website was offline instead of the normal content. As a good nerd, I
turned this operation into a technological one and instead of serving a
static html with nginx, I decided to use
<a href="https://www.varnish-cache.org/">varnish</a>. Yes, varnish. I never wrote
anything about the absolutely amazing architecture of this blog but
basically, static files are generated from
<a href="http://docutils.sourceforge.net/rst.html">RestructuredText</a>, served by
<a href="http://nginx.org/">nginx</a> and cached by varnish. Let&rsquo;s get back to the
point. I wanted varnish to serve a static page with a 503 status code
(for SEO purpose). It took a bit of VCL knowledge and here is how to do
it:</p>

<p>``` text /etc/varnish/maintenance.vcl
backend default {</p>

<pre><code>.host = "127.0.0.1";
.port = "8080";
</code></pre>

<p>}</p>

<p>sub vcl_recv {</p>

<pre><code>error 503;
</code></pre>

<p>}</p>

<p>sub vcl_error {</p>

<pre><code>set obj.http.Content-Type = "text/html; charset=utf-8";
# you can put absolutely what you want
synthetic {"
    &lt;html&gt;
        &lt;head&gt;
        &lt;title&gt;My maintenance page&lt;/title&gt;
        &lt;/head&gt;
        &lt;body&gt;
        &lt;h1&gt;This website is under maintenance.&lt;/h1&gt;
        &lt;/body&gt;
        &lt;/html&gt;
        "};
return (deliver);
</code></pre>

<p>}
```</p>

<p>The trick here is the <code>synthetic</code> keyword which is described in the
varnish documentation like this:</p>

<blockquote><p>The synthetic keyword is used to produce a synthetic response body in
<code>vcl_error</code>. It takes a single string as argument.</p></blockquote>

<p>Now that you have a cool VCL for your maintenance page, you can load
this vcl in varnish like this:</p>

<p><code>bash
varnishadm -T 127.0.0.1:6082 -S /etc/varnish/secret "vcl.load maintenance /etc/varnish/maintenance.vcl"
</code></p>

<p>and to replace the original rules by those described in maintenance.vcl</p>

<p><code>bash
varnishadm -T 127.0.0.1:6082 -S /etc/varnish/secret "vcl.use maintenance"
</code></p>

<p>And varnish will serve the maintenance page. Like a boss.</p>
]]></content>
  </entry>
  
</feed>
